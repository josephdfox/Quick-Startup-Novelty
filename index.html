<script type="module">
    let registryItems = [];
    let chart = null;

    const statusEl = document.getElementById('status');
    const loadingEl = document.getElementById('loading');
    const resultEl = document.getElementById('result');
    const resultScoreEl = document.getElementById('result-score');
    const btn = document.getElementById('analyze-btn');

    async function loadPrecomputedData() {
        try {
            const response = await fetch('data_precomputed.csv');
            if (!response.ok) throw new Error('Not found');
            const text = await response.text();
            const lines = text.trim().split('\n');
            
            // Skip header
            const dataLines = lines.slice(1);
            
            registryItems = dataLines.map(line => {
                const [text, x, y] = line.split(',').map(s => s.trim().replace(/^"/, '').replace(/"$/, ''));
                return {
                    text: text,
                    x: parseFloat(x),
                    y: parseFloat(y)
                };
            });

            statusEl.textContent = `Loaded ${registryItems.length.toLocaleString()} ideas`;
        } catch (err) {
            statusEl.textContent = 'Error loading data_precomputed.csv';
            console.error(err);
            return;
        }

        initChart();
        loadingEl.classList.add('hidden');
    }

    function initChart() {
        const ctx = document.getElementById('scatter-chart').getContext('2d');

        const registryData = registryItems.map(item => ({
            x: item.x,
            y: item.y,
            text: item.text
        }));

        chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Existing Ideas',
                        data: registryData,
                        backgroundColor: '#334b55',
                        pointRadius: 5,
                        pointHoverRadius: 9,
                        pointHoverBackgroundColor: '#506b77'
                    },
                    {
                        label: 'Your Idea',
                        data: [],
                        backgroundColor: '#0db9f2',
                        pointRadius: 20,
                        pointHoverRadius: 28,
                        borderColor: '#0fffff',
                        borderWidth: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#182d34',
                        titleColor: '#f1f5f9',
                        bodyColor: '#f1f5f9',
                        borderColor: '#0db9f2',
                        borderWidth: 1,
                        cornerRadius: 12,
                        displayColors: false,
                        callbacks: {
                            title: () => '',
                            label: context => {
                                if (context.datasetIndex === 1) {
                                    return 'Your Idea: ' + document.getElementById('pitch').value.trim();
                                }
                                return context.raw.text || 'Existing idea';
                            }
                        }
                    }
                },
                scales: {
                    x: { display: false, grid: { display: false } },
                    y: { display: false, grid: { display: false } }
                }
            }
        });
    }

    // For novelty score, we fall back to placeholder since full embeddings aren't loaded
    // (You can add approximate score later if desired)
    async function analyze() {
        const pitch = document.getElementById('pitch').value.trim();
        if (pitch.length < 10) return alert('Please enter a longer description.');

        btn.disabled = true;
        btn.textContent = 'Placing on map...';
        resultEl.classList.add('hidden');

        // Very fast fake placement in center-ish for demo purposes
        // Replace with real embedding if you want accurate position + score
        const spread = 100;
        const userX = (Math.random() - 0.5) * spread;
        const userY = (Math.random() - 0.5) * spread;

        const userPoint = { x: userX, y: userY, text: pitch };

        chart.data.datasets[1].data = [userPoint];
        chart.update();

        // Placeholder score (replace later if you load full embeddings)
        const score = (Math.random() * 0.4 + 0.3).toFixed(3); // 0.3â€“0.7 range
        resultScoreEl.textContent = score;
        resultEl.classList.remove('hidden');

        btn.disabled = false;
        btn.textContent = 'Run Analysis';
    }

    document.getElementById('analyze-btn').addEventListener('click', analyze);
    loadPrecomputedData();
</script>
